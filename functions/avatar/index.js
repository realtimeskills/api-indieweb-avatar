const { builder } = require("@netlify/functions");
const AvatarHtml = require("./avatarHtml.js");

const IMAGE_WIDTH = 64;
const IMAGE_HEIGHT = 64;
const FALLBACK_IMAGE_FORMAT = "png";

async function handler(event, context) {
  // e.g. /https%3A%2F%2Fwww.11ty.dev%2F/
  let pathSplit = event.path.split("/").filter(entry => !!entry);
  let [url] = pathSplit;

  url = decodeURIComponent(url);

  try {
    // output to Function logs
    console.log("Fetching", url);

    let avatar = new AvatarHtml(url);
    await avatar.fetch();

    let stats = await avatar.getAvatar(IMAGE_WIDTH, FALLBACK_IMAGE_FORMAT);
    let format = Object.keys(stats).pop();
    let stat = stats[format][0];

    return {
      statusCode: 200,
      headers: {
        "content-type": stat.sourceType,
      },
      body: stat.buffer.toString("base64"),
      isBase64Encoded: true
    };
  } catch (error) {
    console.log("Error", error);

    return {
      statusCode: 404, 
      headers: {
        "content-type": "image/svg+xml",
        "x-error-message": error.message
      },
      body: `<svg height="${IMAGE_HEIGHT}" viewBox="0 0 32 32" width="32" xml:space="preserve" xmlns="http://www.w3.org/2000/svg"><g fill="#515151"><path d="M13.179 6.288v.027l.016-.02z"/><path d="M15.624 1.028c-7.811 0-14.167 6.355-14.167 14.167 0 7.812 6.356 14.167 14.167 14.167 7.812 0 14.168-6.354 14.168-14.167 0-7.812-6.356-14.167-14.168-14.167zm12.943 14.167c0 .248-.022.49-.037.735-.091-.23-.229-.53-.262-.659-.048-.196-.341-.879-.341-.879s-.293-.39-.488-.488c-.194-.098-.341-.342-.683-.536-.342-.196-.487-.293-.779-.293-.294 0-.585-.391-.928-.586-.342-.194-.39-.097-.39-.097s.39.585.39.731c0 .146.438.39.879.292 0 0 .292.537.438.683.146.146-.049.293-.341.488-.293.194-.244.146-.392.292-.146.146-.633.392-.78.488-.146.097-.731.39-1.023.097-.143-.141-.099-.438-.195-.634-.098-.195-1.122-1.707-1.61-2.389-.085-.12-.293-.49-.438-.585-.146-.099.342-.099.342-.099s0-.342-.049-.585c-.05-.244.049-.585.049-.585s-.488.292-.636.39c-.145.098-.292-.194-.486-.439-.195-.243-.391-.537-.439-.781-.049-.243.244-.341.244-.341l.438-.243s.537-.097.879-.049c.341.049.877.098.877.098s.146-.342-.049-.488c-.194-.146-.635-.39-.83-.341-.194.048.097-.244.34-.439l-.54-.098s-.491.244-.638.293c-.146.048-.4.146-.596.39-.194.244.078.585-.117.683a3.045 3.045 0 0 1-.473.194c-.146.049-.61 0-.61 0-.504 0-.181.46-.05.623l-.39-.476-.289-.682s-.416-.292-.611-.389a31.894 31.894 0 0 1-.796-.439l.042.439.565.572.05.013.294.39-.649.049v-.386c-.612-.148-.452-.3-.521-.347-.145-.097-.484-.342-.484-.342s-.574.098-.721.147c-.147.049-.188.195-.479.292-.294.098-.426.244-.523.39s-.415.585-.608.78c-.196.196-.558.146-.704.146-.147 0-.851-.195-.851-.195v-.827s.095-.464.047-.61l.427-.072.713-.147.209-.147.3-.39s-.337-.244-.094-.585c.117-.164.538-.195.733-.341.194-.146.489-.244.489-.244s.342-.292.683-.634c0 0 .244-.147.536-.245 0 0 .83.732.977.732s.683-.341.683-.341.146-.438.098-.585c-.049-.146-.293-.634-.293-.634s-.146.244-.292.439-.244.439-.244.439-.683-.047-.731-.193c-.05-.147-.146-.388-.196-.533-.047-.147-.438-.142-.729-.044-.294.098.047-.526.047-.526s.294-.368.488-.368.635-.25.828-.298c.196-.049.783-.272 1.025-.272.244 0 .537.105.684.105h.731l1.023-.082s.879.325.585.521c0 0 .343.211.489.357.137.138.491-.127.694-.24 3.649 2.29 6.089 6.341 6.089 10.96zM5.296 7.563c0 .195-.266.242 0 .732.34.634.048.927.048.927s-.83.585-.976.683c-.146.098-.536.634-.293.487.244-.146.536-.292.293.098-.244.391-.683 1.024-.78 1.269s-.585.829-.585 1.122c0 .293-.195.879-.146 1.123.033.17-.075.671-.16.877A12.84 12.84 0 0 1 5.21 7.545c.05.005.086.018.086.018zm1.567-1.87a12.965 12.965 0 0 1 4.133-2.573c-.152.195-.336.395-.336.395s-.341-.001-.976.683c-.633.683-.487.488-.633.682s-.098.244-.44.489c-.34.243-.487.536-.487.536l-.537.195-.438-.195s-.392.147-.343-.049c.014-.052.035-.106.057-.163zm5.846 1.138-.194-.292.194-.439.47.188v-.871l.449-.243.373.536.574.635-.381.292-1.016.195v-.517l-.469.516zm6.342 4.585c.114-.09.487.146.487.146s1.219.244 1.414.39c.196.147.537.245.635.392.098.146.438.585.486.731.05.146.294.684.343.878.049.195.195.683.341.927.146.245.976 1.317 1.268 1.805l.88-.146s-.099.438-.196.585c-.097.146-.39.536-.536.731-.147.195-.341.488-.634.731-.292.243-.294.487-.439.683-.146.195-.342.634-.342.634s.098.976.146 1.171-.341.731-.341.731l-.44.44-.588.779.048.731s-.444.343-.689.537c-.242.194-.204.341-.399.537-.194.194-.957.536-1.152.585s-1.271.195-1.271.195v-.438l-.022-.488s-.148-.585-.295-.78-.083-.489-.327-.732c-.244-.244-.334-.438-.383-.586-.049-.146.053-.584.053-.584s.197-.537.294-.732c.098-.195.001-.487-.097-.683s-.145-.684-.145-.829c0-.146-.392-.391-.538-.537-.146-.146-.097-.342-.097-.535 0-.197-.146-.635-.098-.977.049-.341-.438-.098-.731 0s-.487-.098-.487-.391-.536-.048-.878.146c-.343.195-.732.195-1.124.342-.389.146-.583-.146-.583-.146s-.343-.292-.585-.439c-.245-.146-.489-.438-.685-.682-.194-.245-.683-.977-.73-1.268-.049-.294 0-.49 0-.831s0-.536.048-.78c.049-.244.195-.537.342-.781.146-.244.683-.536.828-.634.146-.097.488-.389.488-.585 0-.195.196-.292.292-.488.099-.195.44-.682.879-.487 0 0 .389-.048.535-.097s.536-.194.729-.292c.195-.098.681-.144.681-.144s.384.153.53.153.622-.085.622-.085.22.707.22.854.146.292.391.39c.241.099 1.364.344 1.852-.047zm5.609 9.561c0 .146-.049.537-.098.732-.051.195-.147.537-.195.73-.049.196-.293.586-.438.684-.146.098-.391.391-.536.439-.146.049-.245-.342-.196-.537.05-.195.293-.731.293-.731s.049-.292.097-.488c.05-.194.635-.438.635-.438l.391-.732c-.002-.001.047.196.047.341zM3.015 18.071c.063.016.153.062.28.175.184.16.293.242.537.341.243.099.341.243.634.39.293.147.196.05.585.488.391.438.342.438.439.683s.244.487.342.635c.098.146.39.243.536.341s.39.195.536.195c.147 0 .586.439.83.487.244.05.244.538.244.538l-.244.682-.196.731.196.585s-.294.245-.487.245c-.18 0-.241.114-.438.06a12.931 12.931 0 0 1-3.794-6.576z"/></g></svg>`,
      isBase64Encoded: false,
    };
  }
}

exports.handler = builder(handler);
